<!DOCTYPE html>
<html>

<head>
	<title>Hamburg Traffic</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.0/mapsjs-ui.css">
	<script src="https://account.here.com/js/sdk/sso.min.js"></script>

	<script>
		var app_id = "inCUge3uprAQEtRaruyaZ8",
			app_code = "9Vyk_MElhgPCytA7z3iuPA";
	</script>

	<script type="text/javascript" charset="UTF-8" src="https://js.api.here.com/v3/3.0/mapsjs-core.js"></script>
	<script type="text/javascript" charset="UTF-8" src="https://js.api.here.com/v3/3.0/mapsjs-service.js"></script>
	<script type="text/javascript" charset="UTF-8" src="https://js.api.here.com/v3/3.0/mapsjs-mapevents.js"></script>
	<script type="text/javascript" charset="UTF-8" src="https://js.api.here.com/v3/3.0/mapsjs-pano.js"></script>
	<script type="text/javascript" charset="UTF-8" src="https://js.api.here.com/v3/3.0/mapsjs-ui.js"></script>


	<link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico" />
	<link rel="stylesheet" media="screen" href="/assets/application.css" data-turbolinks-track="true" />
	<script src="/assets/application.js" data-turbolinks-track="true"></script>

</head>

<body>

	<nav class="navbar navbar-default navbar-fixed-top">
		<div class="container-fluid">
			<div class="row">
				<div class="col-xs-1">
					<div class="navbar-header">
						<a class="navbar-brand" href="http://tcs.ext.here.com/"><img alt="HERE logo" src="/assets/logo.svg" width="60" height="44" /></a>
					</div>
				</div>
				<div class="col-xs-10">
					<div class="header-text">Hamburg Traffic</div>
				</div>
				<div class="col-xs-1">
					<div id="logoutButton" onclick="javascript:logOut()" class="hvr2-overline-reveal hvr2-overline-reveal-min-width">
						<a href="/login">Log Out</a>
					</div>
				</div>
			</div>
		</div>
	</nav>
	<div id="content-padder"></div>
	<div id="content-real">
		<script src="/assets/jszip.min.js"></script>



		<script type="text/javascript" charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/openlayers/4.6.5/ol.js"></script>

		<link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="./css/legend.css">
		<link rel="stylesheet" type="text/css" href="./css/styles.css">

		<style type="text/css">
			.ctrl-panel {
				display: none;
			}
			
			footer {
				display: none;
			}
			
			#mapContainer {
				top: 80px;
				height: calc(100% - 80px);
			}
			
			.loading {
				top: 80px;
				height: calc(100% - 80px);
				width: 100%;
				left: 0px;
				z-index: 10;
			}
			
			.controls {
				z-index: 1;
				top: 96px;
			}
			
			.label {
				margin-left: 0;
				margin-top: 0;
			}
			
			.custom-select {
				position: relative;
				font-family: Arial;
			}
			
			.custom-select select {
				display: none;
			}
			
			.select-selected {
				background-color: #435260;
			}
			
			.select-selected:after {
				position: absolute;
				content: "";
				top: 14px;
				right: 10px;
				width: 0;
				height: 0;
				border: 6px solid transparent;
				border-color: #fff transparent transparent transparent;
			}
			
			.select-selected.select-arrow-active:after {
				border-color: transparent transparent #fff transparent;
				top: 7px;
			}
			
			.select-items div,
			.select-selected {
				color: white;
				padding: 8px 16px;
				border: 1px solid;
				border-radius: 4px;
				cursor: pointer;
			}
			
			.select-items {
				position: absolute;
				background-color: #435260;
				top: 100%;
				left: 0;
				right: 0;
				z-index: 99;
			}
			
			.select-hide {
				display: none;
			}
			
			.select-items div:hover,
			.same-as-selected {
				background-color: rgba(0, 0, 0, 0.1);
			}
			
			.btn-submitNetwork {
				background-color: rgba(72, 218, 208, 0.7);
				padding: 2px 20px;
				color: black;
				display: inline-block;
				border-radius: 4px;
				cursor: pointer;
				-webkit-transition: background-color 0.3s ease-out;
				-moz-transition: background-color 0.3s ease-out;
				-ms-transition: background-color 0.3s ease-out;
				-o-transition: background-color 0.3s ease-out;
				transition: background-color 0.3s ease-out;
				margin-top: 5px;
			}
		</style>
		<div class="loading"></div>
		<div class="controls">
			<div class="group">
				<label for="example">Examples</label>
				<div class="custom-select" style="width:200px;">
					<select id="example">
			<option value="0">Select Demo</option>
			<option value="1" selected>Elbtunnel</option>
			<option value="2">Diesel (B413)</option>
			<option value="3">Diesel (MaxBrauerAllee)</option>
			<option value="4">U26</option>
		</select>
				</div>
			</div>

			<div class="group">
				<div class="title">
					<span class="more"></span> Settings</div>

				<div class="switcher">
					<label class="switch">
				<input class="blocked" type="checkbox">
				<div class="slider round"></div>
				<div class="label">block road</div>
			</label>
				</div>

				<div class="switcher">
					<label class="switch">
				<input class="traffic" type="checkbox">
				<div class="slider round"></div>
				<div class="label">update traffic</div>
			</label>
				</div>

				<div class="switcher">
					<label class="switch">
				<input class="render" type="checkbox">
				<div class="slider round"></div>
				<div class="label">display signs</div>
			</label>
				</div>
				<div class="btn-submitNetwork">update network</div>
			</div>

			<div class="group">
				<div class="btn-calculate">Calculate Route</div>
			</div>
			<!--/div-->
		</div>

		<div id="mapContainer"></div>

		<script type="text/javascript">
			/*
											author domschuette
											(C) HERE 2018
										*/

			// Check whether the environment should use hi-res maps
			var hidpi = ('devicePixelRatio' in window && devicePixelRatio > 1);

			// check if the site was loaded via secure connection
			var secure = (location.protocol === 'https:') ? true : false;

			// Create a platform object to communicate with the HERE REST APIs
			var platform = new H.service.Platform({
					useCIT: true,
					app_id: app_id,
					app_code: app_code,
					useHTTPS: secure
				}),
				defaultLayers = platform.createDefaultLayers(hidpi ? 512 : 256, hidpi ? 320 : null);

			defaultLayers.normal.map = platform.getMapTileService({
				type: 'base'
			}).createTileLayer('basetile', 'reduced.night', hidpi ? 512 : 256, 'png8', null, hidpi ? 2 : 1, false);

			// Instantiate a map in the 'map' div, set the base map to normal
			map = new H.Map(document.getElementById('mapContainer'), defaultLayers.normal.map, {
				center: new H.geo.Point(53.51444639589774, 10.056454367475709),
				zoom: 13,
				pixelRatio: hidpi ? 2 : 1
			});

			// Enable the map event system
			var mapevents = new H.mapevents.MapEvents(map);

			// add request traffic at mapview end event	
			map.addEventListener("mapviewchangeend", function() {
				if (trafficUpdate)
					requestTraffic(map.getViewBounds());
			});

			// Enable map interaction (pan, zoom, pinch-to-zoom)
			var behavior = new H.mapevents.Behavior(mapevents);
			window.addEventListener('resize', function() {
				map.getViewPort().resize();
			});

			// Enable the default UI
			var ui = H.ui.UI.createDefault(map, defaultLayers);

			// globals
			var group = new H.map.Group(),
				detourGroup = new H.map.Group(),
				signGroup = new H.map.Group(),
				linkDataInfoBubble,
				currentBubble,
				SHIFTRIGHT = [0, 3.3, 3.2, 2.3, 2.2, 1.6],
				SHIFTLEFT = [0, -4.7, -3.0, -2.5, -2.3, -1.6],
				icons = {},
				routingGroup = new H.map.Group(),
				waypoint_start,
				waypoint_destination,
				markerStart,
				markerDestination,
				routeLinkHashMap = new Object(),
				legLinkHashMap = new Object(),
				routeStroke = 8,
				trafficUpdate = false,
				blocked = false,
				crerequests = {},
				rmerequests = {};
			trafficInit = false,
				layerInit = false,
				routeColor = ["rgba(64, 224, 208, 0.8)", "rgba(64, 224, 208, 0.7)", "rgba(64, 224, 208, 0.6)"],
				iconSVG = '<svg width="30" height="20" xmlns="http://www.w3.org/2000/svg"><g><rect rx="6" height="20" width="30" y="0" x="0" stroke-width="2" stroke="#FFF" fill="rgb(21,72,137)" /><text x="50%" y="50%" alignment-baseline="middle" text-anchor="middle" font-family="Verdana" font-size="10" fill="#fff">__NO__</text></g></svg>';

			map.addObject(routingGroup);

			$('.traffic').click(function(evt) {
				trafficUpdate = $(this).is(':checked');
				if (trafficUpdate)
					requestTraffic(map.getViewBounds());
				else
					group.removeAll();
			});

			$('.render').click(function(evt) {
				if ($(this).is(':checked'))
					map.addObject(signGroup);
				else
					map.removeObject(signGroup);
			});

			$('.blocked').click(function(evt) {
				blocked = $(this).is(':checked');
			});

			$('.btn-calculate').click(function(evt) {
				var val = $("#example option:selected").val();
				if (val == '0') {

				}
				if (val == '1') routeElbtunnel();
				else if (val == '2') routeDieselFahrverbotB431();
				else if (val == '3') routeDieselFahrverbotMaxBrauerAllee();
				else if (val == '4') routeU26();
			});

			/*	
				$('#example').click(function(evt)
				{
					var val = $( "#example option:selected" ).val();
					if(val == '0')
						$('.btn-calculate').prop('disabled', true);
					else
						$('.btn-calculate').prop('disabled', false);
				});
			*/
			$('.btn-submitNetwork').click(function(evt) {
				prepareNetworkForUpload();
			});

			// load traffic initial
			$('.traffic').trigger('click');
			$('.btn-calculate').prop('disabled', true);

			function createTapLinkHandler(polyline) {
				return function(e) {
					var strip = polyline.getGeometry();
					var lowIndex = Math.floor((strip.getPointCount() - 1) / 2);
					var highIndex = Math.ceil(strip.getPointCount() / 2);
					var center;
					if (lowIndex === highIndex) {
						center = strip.extractPoint(lowIndex);
					} else {
						var lowPoint = strip.extractPoint(lowIndex);
						var highPoint = strip.extractPoint(highIndex);
						center = new H.geo.Point((lowPoint.lat + highPoint.lat) / 2, (lowPoint.lng + highPoint.lng) / 2);
					}

					var linkInfo = polyline.getData().outerHTML;
					linkInfo = "<textarea readonly rows='10' cols='50' style='background-color:black;border:0;font-size:12px;max-width:350px;max-height:400px;'>" + linkInfo + "</textarea>";
					if (!linkDataInfoBubble) {
						linkDataInfoBubble = new H.ui.InfoBubble(center, {
							content: linkInfo
						});
						ui.addBubble(linkDataInfoBubble);
					} else {
						linkDataInfoBubble.setPosition(center);
						linkDataInfoBubble.setContent(linkInfo);
					}
					linkDataInfoBubble.open();
				};
			}

			// projections used by proj4js/2
			var projections = {
				wgs84: "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs",
				EPSG25832: "+proj=utm +zone=32 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs",
			};

			function init() {
				trafficInit = false;
				layerInit = false;
				$('.loading').show();
				loadGML("https://geodienste.hamburg.de/HH_WFS_Bedarfsumleitungen?SERVICE=WFS&VERSION=1.1.0&REQUEST=GetFeature&typename=app:bedarfsumleitungen");
			}

			function loadGML(url) {
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						parseGMLResponse(this);
					} else {
						if (trafficInit == true)
							$('.loading').hide();
					}
				};
				xmlhttp.open("GET", window.location.origin + "/proxy?url=" + url, true);
				xmlhttp.send();
			}

			map.addEventListener('contextmenu', function(e) {
				if (e.target.type == 3) {
					return;
				}
				var clickCoords = map.screenToGeo(e.viewportX, e.viewportY);
				// add routing options 
				e.items.push(new H.util.ContextItem({
					label: 'Route from here',
					callback: function() {
						routingGroup.removeAll();
						waypoint_start = clickCoords;
						markerStart = addMarker(clickCoords);
						waypoint_destination = "";
					}
				}));

				e.items.push(new H.util.ContextItem({
					label: 'Route to here',
					callback: function() {
						waypoint_destination = clickCoords;
						markerDestination = addMarker(clickCoords);
						calculateRoute();
					}
				}));
			});

			function addMarker(coordinates) {
				var marker = new H.map.Marker(coordinates);
				routingGroup.addObject(marker);
				return marker;
			}

			var createPolylineForIndex = function(strip, num) {
				return new H.map.Polyline(strip, {
					style: {
						lineWidth: 8,
						strokeColor: "rgba(64, 224, 208, 0.8)",
						fillColor: "rgba(64, 224, 208, 0.8)"
					}
				});
			};

			function parseGMLResponse(xml) {
				var x, i, xmlDoc, txt, parser = new DOMParser();
				xmlDoc = xml.responseXML != null ? xml.responseXML : parser.parseFromString(xml.responseText, "text/xml");
				txt = "";
				x = xmlDoc.getElementsByTagName('gml:featureMember');

				for (i = 0; i < x.length; i++) {
					var crecoordinates = [];

					//if(x[i].getElementsByTagName('app:umleitung')[0].innerHTML != "U 26")
					//	continue;

					if (x[i] !== undefined && x[i].getElementsByTagName('gml:posList') !== undefined && x[i].getElementsByTagName('gml:posList')[0] !== undefined && x[i].getElementsByTagName('gml:posList')[0].innerHTML !== undefined) {
						var geometry = x[i].getElementsByTagName('gml:posList')[0].innerHTML.split(" ");
						var strip = new H.geo.Strip(),
							j = 0;

						for (; j < geometry.length; j += 2) {
							var coord = proj4(projections['EPSG25832'], projections['wgs84'], [parseFloat(geometry[j]), parseFloat(geometry[j + 1])]);
							strip.pushLatLngAlt(coord[1], coord[0], 0);
							crecoordinates.push("[" + coord[1] + "," + coord[0] + "]");
							// rmecoordinates.push(coord[1] + "," + coord[0]);
						}

						var centerGridSizeXReduction = Math.abs(Math.cos(parseFloat(strip.extractPoint(0).lat) * Math.PI / 180.0));
						var shiftedStrip = shiftPolyline(strip, SHIFTRIGHT[1], centerGridSizeXReduction);

						var link = new H.map.Polyline(shiftedStrip, {
							style: {
								lineWidth: 3,
								strokeColor: "rgba(0, 77, 168)",
								lineJoin: "round"
							}
						});

						link.setData(x[i]);
						link.$JF = -1;

						var direction = x[i].getElementsByTagName('app:richtung')[0].innerHTML == "in Stationierungsrichtung" ? "FORWARD" : "BACKWARD";

						link.addEventListener('pointerenter', createPointerEnterLinkHandler(link));
						link.addEventListener('pointerleave', createPointerLeaveLinkHandler(link));
						link.addEventListener('tap', createTapLinkHandler(link));

						var key = x[i].getElementsByTagName('app:bedarfsumleitungen')[0].getAttribute("gml:id");
						if (crerequests[x[i].getElementsByTagName('app:bedarfsumleitungen')[0].getAttribute("gml:id")] == undefined) {
							crerequests[x[i].getElementsByTagName('app:bedarfsumleitungen')[0].getAttribute("gml:id")] = {};
							crerequests[x[i].getElementsByTagName('app:bedarfsumleitungen')[0].getAttribute("gml:id")].coordinates = [];
						}
						crerequests[x[i].getElementsByTagName('app:bedarfsumleitungen')[0].getAttribute("gml:id")].coordinates.push(crecoordinates);
						crerequests[x[i].getElementsByTagName('app:bedarfsumleitungen')[0].getAttribute("gml:id")].direction = direction;

						/*
						var key = x[i].getElementsByTagName('app:umleitung')[0].innerHTML + '_' + direction;
						if(rmerequests[key] == undefined)
						{
							rmerequests[key] = {};
							rmerequests[key].coordinates = [];
						}
						rmerequests[key].coordinates.push(rmecoordinates.join("\r\n"));
						rmerequests[key].direction = direction;
						*/

						detourGroup.addObject(link);

						if (x[i].getElementsByTagName('app:umleitung') !== undefined && x[i].getElementsByTagName('app:umleitung')[0] !== undefined && x[i].getElementsByTagName('app:umleitung')[0].innerHTML !== undefined) {
							var coord = strip.extractPoint(parseInt(strip.getPointCount() / 2 + .5));
							var marker = new H.map.Marker(coord, {
								icon: getIcon(x[i].getElementsByTagName('app:umleitung')[0].innerHTML)
							});
							signGroup.addObject(marker);
						}
					}
				}
				map.addObject(detourGroup);
				layerInit = true;
				if (layerInit == true && trafficInit == true)
					$('.loading').hide();
			}

			function prepareNetworkForUpload() {
				$('.loading').show();
				submitBypassNetwork();
				/*
						// if we already have the network prepared don't do it again. 
						if(crerequests.length == 0)
						{
							for(var i in rmerequests)
							{
								var body = "LATITUDE,LONGITUDE\r\n";
								body += rmerequests[i].coordinates.join("\r\n");
								submitTrace(body, rmerequests[i].direction);
							}
						}
						else
						{
							submitBypassNetwork();
						}
				*/
			}

			function submitBypassNetwork() {
				var ops = [];
				for (var i in crerequests) {
					ops.push('{"op":"override","shape":[' + crerequests[i].coordinates.join(",") + '],"layer":"LINK_ATTRIBUTE_FCn","data":{"FUNCTIONAL_CLASS":"1","SPEED_CATEGORY":"1"}}');
				}

				// block Elbtunnel
				ops.push('{"op":"override","shape":[[53.54198,9.918284],[53.54257,9.916881],[53.542704,9.916584]],"layer":"LINK_ATTRIBUTE_FCN","data":{"VEHICLE_TYPES":"0","TRAVEL_DIRECTION":"BOTH"}}');
				ops.push('{"op":"override","shape":[[53.541905,9.918134],[53.542668,9.916326]],"layer":"LINK_ATTRIBUTE_FCN","data":{"VEHICLE_TYPES":"0","TRAVEL_DIRECTION":"BOTH"}}');
				ops.push('{"op":"override","shape":[[53.542661,9.915975],[53.54182,9.917989]],"layer":"LINK_ATTRIBUTE_FCN","data":{"VEHICLE_TYPES":"0","TRAVEL_DIRECTION":"BOTH"}}');
				ops.push('{"op":"override","shape":[[53.542543,9.914235],[53.541504,9.916934]],"layer":"LINK_ATTRIBUTE_FCN","data":{"VEHICLE_TYPES":"0","TRAVEL_DIRECTION":"BOTH"}}');

				// add bypass for Elbtunnel
				ops.push('{"op":"override","shape":[[54.0437212,9.9295129],[54.0425849,9.9299026],[54.0421987,9.9299455],[54.0420163,9.9299347],[54.0418875,9.9298489],[54.0417802,9.929688],[54.0417159,9.9295056],[54.0416944,9.9292159],[54.0417051,9.9289691],[54.0418017,9.9287546],[54.0419197,9.92854],[54.0421879,9.9283898],[54.0423381,9.9283254],[54.0424347,9.9283147],[54.0427351,9.9283254],[54.043014,9.9284434],[54.0432608,9.9286366],[54.0435183,9.9289477],[54.0436578,9.9292266],[54.0438402,9.9296558],[54.043926,9.9299884],[54.0440333,9.9305892],[54.0440762,9.9312007],[54.0440977,9.9318016],[54.0440118,9.9352348],[54.0437329,9.9408889],[54.0436149,9.9427664],[54.043293,9.9470472],[54.0431106,9.9491823],[54.0428102,9.9523151],[54.0420699,9.9591708],[54.0418875,9.9611986],[54.0417588,9.9631298],[54.0416408,9.9664557],[54.0416193,9.968977],[54.0417373,9.9743092],[54.0418124,9.9768627],[54.0418446,9.9795341],[54.0417373,9.9831283],[54.0416729,9.9842548],[54.0413511,9.9877095],[54.0410078,9.9903166],[54.0406215,9.9926555],[54.0401602,9.9949515],[54.039731,9.996829],[54.0386367,10.0012279],[54.0383041,10.0028586],[54.0381539,10.0038028],[54.0380037,10.0049829],[54.03795,10.0056803],[54.0378857,10.0070643],[54.0378857,10.0076652],[54.0379286,10.0088561],[54.037993,10.0097573],[54.0380681,10.0104868],[54.0383148,10.0122571],[54.0384865,10.0133622],[54.0390551,10.0165915],[54.0392804,10.017997],[54.0394092,10.0190055],[54.039495,10.0198317],[54.0395916,10.0213337],[54.0395916,10.0225568],[54.0395486,10.023458],[54.0394735,10.0242734],[54.0394199,10.024606],[54.0391517,10.0259256],[54.038862,10.026902],[54.0386045,10.0275564],[54.0381324,10.0285435],[54.0378428,10.029037],[54.0375853,10.0294232],[54.0371668,10.0299919],[54.0362549,10.0310647],[54.0355146,10.0319016],[54.0350533,10.0324917],[54.0346563,10.0330603],[54.0339482,10.0341654],[54.0336156,10.0347877],[54.0307081,10.0404847],[54.0296352,10.0427377],[54.0288842,10.0444973],[54.0285945,10.0452268],[54.0278757,10.0471902],[54.0275753,10.0481343],[54.0272748,10.0491107],[54.0265989,10.0515568],[54.0256763,10.0552797],[54.025054,10.0575972],[54.0248072,10.0583911],[54.0245068,10.0592816],[54.0239918,10.060612],[54.0234447,10.0618351],[54.0232193,10.0622857],[54.023037,10.0626397],[54.0223503,10.0638521],[54.0208912,10.0660837],[54.0201187,10.0673497],[54.0197968,10.0679398],[54.019593,10.0683689],[54.0192497,10.0691199],[54.01896,10.0698066],[54.0184987,10.0711799],[54.0181661,10.0724566],[54.0180159,10.0731647],[54.017061,10.0786901],[54.0151405,10.0900841],[54.0141642,10.0957811],[54.013778,10.0981629],[54.0136707,10.0989783],[54.0136063,10.0998151],[54.0135849,10.1008129],[54.0136385,10.101757],[54.0137136,10.1025403],[54.0138209,10.1033235],[54.0139496,10.103935],[54.0141857,10.1048148],[54.0143573,10.1053298],[54.0146899,10.1061773],[54.0150332,10.1068747],[54.0168893,10.1102221],[54.018048,10.1122606],[54.0184236,10.1129794],[54.0185845,10.113312],[54.0189064,10.1140952],[54.0190351,10.1144493],[54.0193033,10.1152968],[54.0194321,10.1158655],[54.0195823,10.1166594],[54.020344,10.1215196],[54.0205264,10.1227748],[54.020741,10.1240516],[54.0208912,10.1251245],[54.0209556,10.1259291],[54.0209877,10.1265621],[54.0209556,10.1277852],[54.0209126,10.1284182],[54.0207732,10.1293945],[54.0206981,10.1298451],[54.0189278,10.1384068],[54.018445,10.1409173],[54.0178871,10.1445651],[54.0175545,10.1465285],[54.0168357,10.1504982],[54.0162349,10.1540816],[54.0157735,10.1577187],[54.015162,10.1623428],[54.0149367,10.1637483],[54.0147436,10.1647353],[54.0145504,10.1656044],[54.0142179,10.1669133],[54.0139496,10.167836],[54.013499,10.1691663],[54.0132737,10.1697779],[54.0129948,10.1704645],[54.0127373,10.1710439],[54.0123081,10.1719236],[54.0120614,10.172385],[54.0113747,10.1735544],[54.0108597,10.1743269],[54.0105379,10.1747668],[54.0100551,10.1753783],[54.0095937,10.175904],[54.0087891,10.1767087],[54.0083599,10.1770949],[54.0078664,10.1775026],[54.0073299,10.1779103],[54.0065575,10.1784146],[54.0061605,10.1786721],[54.0055168,10.1790369],[54.0051198,10.1792514],[54.0042508,10.1796699],[54.0035748,10.1799595],[54.0026951,10.1803029],[54.0019011,10.1805818],[54.0013218,10.1807749],[53.9983284,10.1816869],[53.9970624,10.1820946],[53.9960647,10.1824594],[53.9950454,10.1828778],[53.9942193,10.1832533],[53.9933825,10.1836824],[53.9926422,10.1841223],[53.9917839,10.1847124],[53.9910865,10.1852381],[53.9898205,10.1863539],[53.9888656,10.1873624],[53.9884901,10.1877916],[53.9877069,10.1888001],[53.9872456,10.1894224],[53.9860654,10.1912677],[53.9850569,10.1931667],[53.9845955,10.1941323],[53.9840806,10.1953125],[53.9834905,10.1967931],[53.9825249,10.1994431],[53.9817202,10.2017283],[53.9750683,10.2210295],[53.9741993,10.2236259],[53.9736092,10.225482],[53.973223,10.2267909],[53.972075,10.2309322],[53.9714849,10.2331531],[53.9699507,10.2392042],[53.9698756,10.2393758],[53.9697254,10.239923],[53.969543,10.2405989],[53.9694142,10.2411675],[53.9692748,10.2418327],[53.9688456,10.2446759],[53.9685988,10.2459311],[53.9683521,10.2468109],[53.9678693,10.2482808],[53.9665926,10.2514458],[53.96523,10.2546322],[53.9649296,10.2552545],[53.9646399,10.2558017],[53.9642751,10.2564561],[53.9639318,10.2570033],[53.963449,10.2577221],[53.9631701,10.2580869],[53.9623654,10.2590203],[53.9623332,10.259074],[53.9619362,10.2594817],[53.9610565,10.2603292],[53.9595652,10.2616918],[53.9589751,10.2622819],[53.9584601,10.2628613],[53.9579237,10.2635157],[53.9572155,10.2645135],[53.9563787,10.2658975],[53.9542222,10.2699208],[53.9535356,10.2711439],[53.953321,10.271498],[53.9528167,10.2722383],[53.9521408,10.2730966],[53.9519048,10.2733648],[53.9514434,10.2738154],[53.9508319,10.2743411],[53.9504349,10.2746201],[53.9496088,10.2750921],[53.948729,10.2754891],[53.9479566,10.2757466],[53.9474952,10.2758753],[53.9467978,10.2760041],[53.9460468,10.2760684],[53.9455748,10.2760577],[53.9451349,10.2760255],[53.9435899,10.2758861],[53.9431715,10.2758861],[53.9425492,10.2759182],[53.9420557,10.2759826],[53.9415514,10.2760792],[53.9389443,10.2765942],[53.9387619,10.2766156],[53.9380538,10.2767551],[53.9360046,10.2771735],[53.9345992,10.277313],[53.9332795,10.2773452],[53.9322817,10.2773023],[53.931284,10.2771842],[53.9303935,10.2770233],[53.9300501,10.2769375],[53.9296961,10.2768731],[53.9286768,10.2765834],[53.9281082,10.276401],[53.9276361,10.2762294],[53.9262307,10.2756393],[53.9234519,10.2742982],[53.9227331,10.2740085],[53.9218748,10.273751],[53.9214349,10.2736652],[53.9204478,10.2736008],[53.9197612,10.2736223],[53.9189672,10.2736866],[53.9172614,10.2738798],[53.9120471,10.2745128],[53.9101481,10.2747166],[53.9082599,10.2749527],[53.9062536,10.2751672],[53.9051592,10.2753067],[53.9041507,10.2754676],[53.9028203,10.2757251],[53.9020586,10.2759075],[53.9012969,10.2761328],[53.900739,10.2763152],[53.8998592,10.2766478],[53.8993335,10.2768946],[53.8980889,10.2775705],[53.8976061,10.2778816],[53.8968551,10.2784181],[53.8963294,10.2788472],[53.8956857,10.279448],[53.8954067,10.2797377],[53.8948166,10.2804136],[53.8943231,10.2810574],[53.8939154,10.2816367],[53.8934648,10.2823555],[53.8927352,10.2836967],[53.8924563,10.2843082],[53.8920808,10.2852309],[53.8915336,10.2869153],[53.8912654,10.2880096],[53.8909864,10.2893615],[53.8903749,10.2931917],[53.8899565,10.2954555],[53.8897848,10.2962494],[53.8896024,10.296979],[53.8892376,10.2982986],[53.8889694,10.2991462],[53.8885939,10.3002083],[53.8881433,10.3012919],[53.8875747,10.3025472],[53.8868344,10.3039205],[53.88574,10.305562],[53.8853431,10.3060663],[53.8842809,10.3072357],[53.8837337,10.3077614],[53.8833904,10.3080726],[53.8831115,10.3082979],[53.8823068,10.3088558],[53.8816953,10.3092313],[53.8810623,10.3095639],[53.8804507,10.3097999],[53.8798177,10.3100145],[53.8791847,10.3101647],[53.8785195,10.3102934],[53.8776505,10.3103685],[53.8769531,10.3104007],[53.8765669,10.3104115],[53.8755906,10.3103793],[53.8718247,10.310154],[53.8713527,10.3101432],[53.8706446,10.310154],[53.869282,10.3102505],[53.8687456,10.310272],[53.8681126,10.3102291],[53.8676727,10.3101647],[53.8672757,10.3100681],[53.8668036,10.3099287],[53.866396,10.3097677],[53.8657951,10.3094566],[53.8652802,10.3091347],[53.8646686,10.3086841],[53.8642824,10.3083515],[53.8628447,10.3069675],[53.8621151,10.3063452],[53.8617504,10.3060877],[53.8609886,10.30568],[53.8604414,10.3054762],[53.8599586,10.3053689],[53.8595402,10.3053045],[53.8590896,10.3052831],[53.8576734,10.305326],[53.8560748,10.3054225],[53.8548195,10.3054547],[53.8538969,10.3054976],[53.8518262,10.30568],[53.8503242,10.3059268],[53.8492513,10.306195],[53.8484788,10.3064311],[53.8474488,10.3067851],[53.8432324,10.308491],[53.8418269,10.3090274],[53.8410008,10.3092849],[53.8404858,10.3094029],[53.8397241,10.3095424],[53.8385975,10.3096604],[53.8378572,10.3096604],[53.8360763,10.3095317],[53.8355505,10.309521],[53.835175,10.3095317],[53.834703,10.3096175],[53.8340163,10.3098428],[53.8334584,10.3101218],[53.8329327,10.3104758],[53.832407,10.3109157],[53.8321602,10.3111839],[53.8319027,10.3114843],[53.831495,10.31201],[53.8309586,10.3128147],[53.8308835,10.3129649],[53.8301969,10.3141236],[53.8290703,10.3159153],[53.8285983,10.3165805],[53.8281369,10.3171921],[53.8276112,10.3178465],[53.827064,10.3184688],[53.8263881,10.3191769],[53.8258946,10.319649],[53.8252723,10.3202069],[53.8246608,10.3206897],[53.8240385,10.321151],[53.8224721,10.3222668],[53.8208413,10.3234148],[53.8199508,10.3240156],[53.8191032,10.3245521],[53.8184488,10.3248632],[53.8180411,10.3250241],[53.8176334,10.3251636],[53.8167,10.3253353],[53.8161957,10.3253567],[53.8157022,10.3253567],[53.8153374,10.3253245],[53.8147151,10.3252065],[53.8140607,10.3250349],[53.8137174,10.3248954],[53.8130414,10.3245735],[53.8125801,10.3243053],[53.8121188,10.3240049],[53.8110352,10.3231573],[53.8025594,10.3163552],[53.8016689,10.3156686],[53.8010037,10.3152394],[53.8003278,10.3148854],[53.7993407,10.3145099],[53.7982142,10.3142953],[53.7973344,10.3142416],[53.7968087,10.3142738],[53.7963045,10.3143382],[53.7958646,10.3144348],[53.7948775,10.3147781],[53.7946951,10.3148746],[53.7942553,10.315057],[53.7934828,10.3155184],[53.7929034,10.315969],[53.792485,10.316323],[53.7920558,10.3167093],[53.7916696,10.3170848],[53.7912726,10.3175247],[53.7908971,10.3179002],[53.7897706,10.3191125],[53.7891591,10.3197348],[53.7856936,10.3234148],[53.7848032,10.3242946],[53.7843847,10.3246701],[53.7837732,10.3251851],[53.7834299,10.3254533],[53.7829363,10.3257751],[53.7825394,10.3260112],[53.7816381,10.3264511],[53.7808549,10.3267407],[53.7804794,10.326848],[53.7801468,10.3269339],[53.7793744,10.3270733],[53.7786448,10.3271163],[53.7782478,10.3271055],[53.7777865,10.3270733],[53.7771428,10.3269768],[53.7766385,10.3268588],[53.7761343,10.3267086],[53.7751901,10.3263545],[53.7745893,10.3260648],[53.7741923,10.3258181],[53.7737203,10.3254855],[53.7727225,10.3247237],[53.7709093,10.323168],[53.7684739,10.321033],[53.7679374,10.320636],[53.7672508,10.3202283],[53.7668002,10.320003],[53.7663066,10.3197992],[53.7655663,10.3195846],[53.7649655,10.3194451],[53.7643969,10.3194129],[53.7638497,10.3194237],[53.7634099,10.3194773],[53.7629485,10.3195632],[53.7623906,10.3197134],[53.7618434,10.3199172],[53.7613928,10.3201318],[53.7601912,10.3208613],[53.7569726,10.3231466],[53.7561142,10.323683],[53.75561,10.3239298],[53.7547195,10.3242946],[53.7542796,10.3244233],[53.753475,10.324595],[53.7530994,10.3246379],[53.7526166,10.3246701],[53.7522411,10.3246808],[53.7517047,10.3246701],[53.7508357,10.3245628],[53.7502563,10.3244126],[53.7498808,10.3242946],[53.7489581,10.3239191],[53.7482178,10.3235435],[53.747381,10.3230071],[53.7455142,10.3216231],[53.744688,10.3210652],[53.7441945,10.3207862],[53.7438941,10.3206468],[53.7434864,10.3204858],[53.7431216,10.3203785],[53.7422848,10.3202069],[53.741641,10.3201425],[53.7410188,10.3201747],[53.7404501,10.3202713],[53.7400424,10.3203678],[53.7398064,10.3204429],[53.7395167,10.3205609],[53.7389159,10.3208506],[53.7382936,10.3212261],[53.7364805,10.3225672],[53.7358904,10.3229856],[53.7353003,10.3233612],[53.7349677,10.3235543],[53.734678,10.3236938],[53.7339914,10.323962],[53.7336266,10.3240585],[53.7319207,10.3244019],[53.7280513,10.3250704],[53.7257624,10.3254747],[53.7251186,10.3256035],[53.7230587,10.3259468],[53.7222004,10.3261292],[53.7211704,10.3265262],[53.720355,10.326966],[53.7198186,10.3273737],[53.7193894,10.32776],[53.7188637,10.3283072],[53.7186384,10.3285646],[53.7183058,10.3289938],[53.7177157,10.3299272],[53.7173617,10.3305709],[53.7169862,10.3313863],[53.7168038,10.3318262],[53.7165034,10.3323734],[53.7163746,10.3325772],[53.7159026,10.3330493],[53.7157094,10.3331888],[53.7148404,10.3337467],[53.7143791,10.3339934],[53.714186,10.3340578],[53.7140572,10.3340793],[53.7139177,10.3340685],[53.7137139,10.3340042],[53.7129736,10.3335214],[53.712877,10.3334999],[53.712641,10.3333497],[53.7120187,10.3330278],[53.711493,10.3327811],[53.7108707,10.3324378],[53.7107527,10.3323948],[53.7106347,10.3324056],[53.7095082,10.3317726],[53.6983824,10.3252923],[53.6954749,10.3235757],[53.6951423,10.3233612],[53.6932111,10.3220308],[53.6922777,10.3213656],[53.6917949,10.3210437],[53.6891019,10.3191555],[53.6881685,10.3184688],[53.6871493,10.3177929],[53.685894,10.3168809],[53.6853683,10.3165376],[53.6783516,10.3115702],[53.6713672,10.3066885],[53.6692321,10.3051758],[53.6676013,10.3040385],[53.6661959,10.3030837],[53.6651659,10.3023326],[53.6585677,10.2977192],[53.6575699,10.2970004],[53.6570013,10.2966464],[53.6560142,10.2958846],[53.6554885,10.2954447],[53.6547911,10.2948225],[53.654319,10.2943718],[53.6537504,10.2937603],[53.6532354,10.2931595],[53.6527741,10.2925909],[53.6501348,10.2891147],[53.6481822,10.2864969],[53.6471951,10.2852201],[53.646723,10.2845657],[53.6451566,10.2824736],[53.6443949,10.2813148],[53.6440408,10.2807248],[53.6435151,10.2797377],[53.643086,10.2788365],[53.6426353,10.2778494],[53.6423242,10.2770448],[53.6417985,10.2754247],[53.6412835,10.2736223],[53.6403823,10.2703285],[53.6401999,10.2697599],[53.6394489,10.2670562],[53.6388481,10.2649534],[53.6385906,10.2641165],[53.6380649,10.2626789],[53.6377001,10.2617562],[53.637464,10.2612305],[53.6368954,10.2601039],[53.6365628,10.2594709],[53.6361873,10.2588594],[53.6357582,10.2581835],[53.6345029,10.2562952],[53.6282372,10.2470362],[53.626864,10.2449548],[53.6262417,10.2440858],[53.6254263,10.2428949],[53.6229801,10.2392578],[53.6223793,10.238378],[53.6212957,10.2369297],[53.621006,10.2365971],[53.6198795,10.2354276],[53.6196327,10.235213],[53.6186564,10.2344513],[53.6182916,10.2341938],[53.617841,10.2339256],[53.617208,10.2336144],[53.6165214,10.233314],[53.6158454,10.2330458],[53.6151052,10.2327991],[53.614794,10.2327347],[53.6078739,10.2307713],[53.6053312,10.230031],[53.6046231,10.2297843],[53.603915,10.2294946],[53.6025095,10.2287436],[53.6018443,10.2283037],[53.6013722,10.2279603],[53.6005139,10.2272844],[53.600117,10.2269304],[53.5989904,10.2258146],[53.5980999,10.2248168],[53.5815561,10.2057087],[53.5768783,10.2002478],[53.5755587,10.198735],[53.5752797,10.1984346],[53.5750544,10.1981449],[53.5732949,10.1961172],[53.5725653,10.1953125],[53.5691857,10.1914287],[53.5683918,10.1904631],[53.5674155,10.189122],[53.56704,10.1885748],[53.5666215,10.1878881],[53.5661602,10.1870835],[53.5656559,10.1861608],[53.5651946,10.1852274],[53.5647655,10.184294],[53.5642397,10.1829851],[53.563875,10.1819873],[53.5635424,10.1810002],[53.5632312,10.1799917],[53.5626304,10.1779318],[53.5624051,10.177052],[53.5621583,10.1758289],[53.5619974,10.1749277],[53.5618794,10.1740801],[53.561697,10.1724601],[53.5615897,10.1701963],[53.5615683,10.1686621],[53.5615897,10.1657438],[53.5615575,10.1639521],[53.561461,10.1630831],[53.5613644,10.1624179],[53.5613,10.1620853],[53.5611498,10.1613772],[53.5608709,10.1603365],[53.5607529,10.159961],[53.5603344,10.1588452],[53.5597014,10.1575041],[53.5593581,10.1568711],[53.5586607,10.1557231],[53.5581458,10.1550257],[53.5574806,10.1541996],[53.5570192,10.1536953],[53.5558927,10.1526439],[53.5550666,10.1520216],[53.5540688,10.1513457],[53.5536289,10.1510775],[53.5524702,10.1504552],[53.5516441,10.1500475],[53.5499704,10.1493609],[53.5485113,10.1488137],[53.5464621,10.1479983],[53.5459685,10.1478374],[53.5455501,10.1476765],[53.5445952,10.1472795],[53.5440266,10.147022],[53.5425997,10.1463246],[53.5417521,10.1458633],[53.540808,10.1452947],[53.539896,10.1446724],[53.5368919,10.1423013],[53.5362589,10.1417649],[53.5358512,10.141443],[53.5348749,10.1405847],[53.5347676,10.1405096],[53.5335338,10.1393831],[53.5325146,10.138396],[53.5322571,10.1381707],[53.530283,10.1362503],[53.5285342,10.1344264],[53.5281801,10.1340938],[53.5274613,10.1332676],[53.5266244,10.1322484],[53.5265386,10.1321733],[53.5253906,10.1307142],[53.5243607,10.1293409],[53.5240602,10.1288903],[53.5235453,10.1281822],[53.5228586,10.1271737],[53.5222471,10.126251],[53.5214853,10.1250494],[53.5199833,10.1225173],[53.5187817,10.1203394],[53.5173547,10.1175821],[53.5156488,10.1138592],[53.5148335,10.1119173],[53.5135031,10.1085377],[53.5123658,10.1053512],[53.5107458,10.1002014],[53.5100913,10.0979483],[53.5096085,10.0961673],[53.5083747,10.0913393],[53.5079348,10.0891292],[53.5077524,10.0880778],[53.5075057,10.0864363],[53.5072911,10.0841188],[53.5072374,10.0833893],[53.507216,10.0826812],[53.5072267,10.0808573],[53.5072911,10.0795913],[53.5073447,10.0789154],[53.5075915,10.0766838],[53.5077846,10.0754285],[53.5081601,10.0732934],[53.5088038,10.0699246],[53.5088468,10.0695384],[53.5089433,10.0689805],[53.5090935,10.0675642],[53.5092008,10.0662017],[53.5092437,10.0653863],[53.5092974,10.0623286],[53.5094047,10.0586164],[53.5094261,10.0572217],[53.5095227,10.0537133],[53.5095549,10.0530696],[53.509587,10.0510848],[53.5097051,10.0466537],[53.5097051,10.0458169],[53.5097802,10.0419009],[53.5097694,10.0410426],[53.5097051,10.0399375],[53.5096407,10.0392723],[53.5094798,10.0383067],[53.5093188,10.0376844],[53.5092223,10.0373733],[53.5089648,10.0367081],[53.5087395,10.0362468],[53.5084498,10.0357962],[53.5079455,10.0352275],[53.5076237,10.03497],[53.5073876,10.0348091],[53.5071945,10.0347126],[53.5069799,10.0346375],[53.5066473,10.0345731],[53.5062504,10.0345194],[53.5057461,10.034616],[53.5053492,10.0347877],[53.505156,10.0348949],[53.5047913,10.0351846],[53.504287,10.0357533],[53.5039866,10.0362039],[53.5033,10.0373197],[53.5029674,10.0377917],[53.5025918,10.0382102],[53.5024416,10.0383496],[53.5021842,10.0385213],[53.5018086,10.0386822],[53.5015833,10.0387466],[53.5013902,10.0387573],[53.5011649,10.0387466],[53.5008216,10.0387037],[53.5003924,10.0385749],[53.4997809,10.0383496],[53.4993196,10.0381029],[53.4986758,10.0376844],[53.4982252,10.0373197],[53.4976995,10.036869],[53.4971523,10.0364399],[53.4940946,10.0339293],[53.4936869,10.0336182],[53.4932578,10.0332642],[53.490243,10.0307214],[53.4879577,10.0288117],[53.4877753,10.0286829],[53.4864986,10.0275886],[53.4823895,10.0241554],[53.4814131,10.0234151],[53.4812093,10.0232863],[53.4804797,10.0229001],[53.4799433,10.0226748],[53.479557,10.0225675],[53.4793746,10.0224924],[53.4791923,10.0224388],[53.4786451,10.0223315],[53.4782803,10.0222778],[53.4777546,10.0222671],[53.4773791,10.0222886],[53.4770572,10.02231],[53.4764886,10.0223958],[53.4755981,10.0225782],[53.4731841,10.0231147],[53.4712315,10.0235009],[53.4689999,10.0239944],[53.4666395,10.024488],[53.466146,10.0245631],[53.4625304,10.0255501],[53.4623909,10.0256038],[53.4616828,10.0258076],[53.4614575,10.0258934],[53.4612322,10.0259471],[53.4583569,10.0267947],[53.4538615,10.0280714],[53.4520376,10.0286078],[53.4511256,10.0288439],[53.4502351,10.0290048],[53.4495592,10.0291014],[53.4446347,10.0295413],[53.4427464,10.0297666],[53.4422958,10.0298417],[53.4417164,10.0299811],[53.4410727,10.0301528],[53.4398711,10.0305498],[53.438133,10.0311935],[53.4298933,10.0341439],[53.4289706,10.0344551],[53.4286058,10.0345409],[53.4274578,10.0346911],[53.4268034,10.0346589],[53.4264171,10.0346053],[53.4260631,10.0345087],[53.425194,10.0342083],[53.4242392,10.0337684],[53.422823,10.0330496],[53.4202158,10.0317729],[53.418467,10.0309789],[53.4178126,10.0307322],[53.4175444,10.0306463],[53.4165466,10.0303459],[53.415463,10.0300777],[53.4046805,10.0274599],[53.4033072,10.0271487],[53.4007215,10.026505],[53.4001529,10.0263441],[53.3992624,10.0260651],[53.3980608,10.0256145],[53.3970737,10.0251746],[53.3969986,10.0251532],[53.3968163,10.0250459],[53.3962262,10.0247991],[53.3960652,10.024606],[53.3959258,10.0244772],[53.3951533,10.0240374],[53.3910871,10.0222564],[53.3904648,10.0219452],[53.3902395,10.0216877],[53.3901429,10.0215375],[53.3900678,10.0213552],[53.3900249,10.0211942],[53.3899927,10.0209796],[53.3900249,10.0206149],[53.3900785,10.0204217],[53.3902287,10.0201428],[53.390336,10.0200462],[53.3904433,10.0199926],[53.3905613,10.0199711],[53.3906686,10.0199711],[53.3907866,10.0200033],[53.3908939,10.0200891],[53.3909798,10.0201964],[53.3910441,10.0203252],[53.3910978,10.0204968],[53.3911622,10.0208938],[53.3912051,10.0213766],[53.3909369,10.0233829],[53.3907652,10.023737],[53.3906794,10.023855],[53.3905828,10.0239408],[53.3904648,10.0239623],[53.3903468,10.0239301],[53.3896816,10.0235975],[53.389585,10.0235224],[53.3894885,10.0234151],[53.3894348,10.0232971],[53.3893919,10.0231361],[53.3893812,10.0229967],[53.3893919,10.0228572],[53.3894455,10.0226748],[53.3895099,10.0225997],[53.3896065,10.0225246],[53.3897781,10.0224388],[53.3915591,10.0232542],[53.3944452,10.0245416],[53.395271,10.0248269]],"layer":"LINK_ATTRIBUTE_FCn","data":{"FUNCTIONAL_CLASS":"1","SPEED_CATEGORY":"1","TRAVEL_DIRECTION":"BOTH"}}');

				// lower priority on original route
				// ops.push('{"op":"override","shape":[[54.03919,9.93097],[53.68859,9.94571],[53.65818,9.93226],[53.64953,9.93038],[53.64557,9.93101],[53.6439,9.93033],[53.6439,9.93033],[53.6439,9.93033],[53.6439,9.93033],[53.64394,9.93019],[53.64394,9.93019],[53.64394,9.93019],[53.64394,9.93019],[53.66555,9.93694],[53.67597,9.94483]],"layer":"LINK_ATTRIBUTE_FCN","data":{"SPEED_CATEGORY":"5","TRAVEL_DIRECTION":"BOTH"}}');

				// block Diesel Fahrverbot (B431)
				ops.push('{"op":"override","shape":[[53.565319,9.9126828],[53.5649586,9.9140775],[53.5645938,9.9158156],[53.564465,9.916352],[53.5643041,9.917264],[53.5641861,9.9177039],[53.564111,9.9181223],[53.5640466,9.9185514],[53.5639393,9.9203324],[53.563875,9.922092],[53.5636604,9.9262011],[53.5634995,9.9287546],[53.5634351,9.9301064],[53.5634136,9.9311256],[53.5634351,9.931705],[53.5634995,9.9323165],[53.563553,9.9326599],[53.5636604,9.9331748],[53.5637033,9.9335182],[53.5637569,9.9346018],[53.5637462,9.9358034],[53.5636497,9.9384749],[53.5635746,9.941536],[53.5633278,9.9428415],[53.5629952,9.945328],[53.5629201,9.9458027],[53.5628557,9.9460924],[53.5626948,9.947015],[53.56233,9.9486029],[53.562158,9.9497831],[53.5617721,9.9528086],[53.5613859,9.9546862],[53.561353,9.9549115],[53.5610211,9.9563277],[53.560533,9.9585164],[53.5603774,9.9590957],[53.5601628,9.959718],[53.559798,9.9606407],[53.5595298,9.9611986],[53.5592616,9.961617],[53.5586715,9.9627221]],"layer":"LINK_ATTRIBUTE_FCN","data":{"VEHICLE_TYPES":"0","TRAVEL_DIRECTION":"BOTH"}}');


				// add Diesel Umleitung for B431
				ops.push('{"op":"override","shape":[[53.5641937,9.9192637],[53.5644114,9.9191737],[53.5650873,9.9189484],[53.5656559,9.9187016],[53.56704,9.918251],[53.5676193,9.9180472],[53.5682952,9.917897],[53.569293,9.9177253],[53.5696149,9.9177039],[53.5698831,9.9177253],[53.5700226,9.9177575],[53.5703659,9.9178863],[53.5708702,9.9181437],[53.5707521,9.9190772],[53.5707307,9.9194312],[53.5707307,9.9199033],[53.5708165,9.9222207],[53.5708594,9.9227571],[53.5709667,9.9234331],[53.5715461,9.9255788],[53.5718679,9.9265981],[53.5729086,9.9294734],[53.5735202,9.9312651],[53.5736275,9.9316406],[53.5737026,9.9319839],[53.5737884,9.9326491],[53.5737991,9.9329174],[53.5737777,9.9333036],[53.5737455,9.9336147],[53.5736704,9.9340546],[53.5735738,9.9344087],[53.5731554,9.9354923],[53.5730481,9.9358571],[53.5729301,9.936415],[53.5728765,9.936769],[53.5728113,9.937998],[53.5727799,9.9405563],[53.5727155,9.9408782],[53.5726726,9.941479],[53.5723507,9.9418759],[53.5722971,9.9423051],[53.5722864,9.9428844],[53.5726297,9.9440861],[53.5728014,9.944644],[53.5729516,9.9450624],[53.5732198,9.946146],[53.5732949,9.9465752],[53.5734236,9.9481201],[53.5734236,9.9484098],[53.5733914,9.9487209],[53.5733163,9.9489784],[53.5732305,9.949193],[53.5731447,9.9493432],[53.5730052,9.9496543],[53.5727155,9.9501586],[53.5719752,9.9515641],[53.5715461,9.9524224],[53.5714602,9.9526048],[53.5713637,9.9529052],[53.5712349,9.9531949],[53.5711491,9.9534738],[53.5709882,9.9537849],[53.5707307,9.9544823],[53.570441,9.9554801],[53.5701942,9.9565852],[53.5701621,9.9569821],[53.5700226,9.9576044],[53.5705161,9.957937],[53.5715246,9.9586558],[53.5714173,9.9587846],[53.5709774,9.9595249],[53.5708916,9.9596429],[53.5707951,9.9597394],[53.5706985,9.9598038],[53.5705483,9.9598789],[53.5701513,9.9598897],[53.5696046,9.959872],[53.5694647,9.9598682],[53.5694325,9.9601364],[53.5693789,9.9612093],[53.5693681,9.9618959],[53.5694003,9.9630547],[53.5693896,9.9634945],[53.5691428,9.9637306],[53.5688317,9.9639452],[53.5680914,9.9644065],[53.5669649,9.9650717],[53.5663426,9.9653935],[53.5656238,9.9657154],[53.5654736,9.9657583],[53.5653019,9.9657583],[53.5647118,9.9656618],[53.5639071,9.9654472],[53.5636497,9.9654472],[53.5631454,9.9655116],[53.5623622,9.9658549],[53.5621691,9.9658871],[53.5620832,9.9658871],[53.5619545,9.9658549],[53.5606563,9.9651253],[53.5603774,9.9649537],[53.5597551,9.9645138],[53.5594547,9.9643314],[53.5593367,9.9641812],[53.5592079,9.9640524],[53.5587251,9.9640203],[53.5584569,9.9639666],[53.5583176,9.9639191]],"layer":"LINK_ATTRIBUTE_FCn","data":{"FUNCTIONAL_CLASS":"1","SPEED_CATEGORY":"1","TRAVEL_DIRECTION":"BOTH"}}');

				// block Diesel Fahrverbot (Max Brauer Allee) Gerichtsstraße -> Holstenstraße
				ops.push('{"op":"override","shape":[[53.5552812,9.9423695],[53.5571909,9.9459958],[53.5576844,9.947015],[53.557781,9.9472618],[53.5581243,9.9479914],[53.5582638,9.9483347],[53.5585964,9.9493647]],"layer":"LINK_ATTRIBUTE_FCN","data":{"VEHICLE_TYPES":"0","TRAVEL_DIRECTION":"BOTH"}}');

				// block Diesel Fahrverbot (Max Brauer Allee) Holstenstraße -> Gerichtsstraße 
				ops.push('{"op":"override","shape":[[53.5586524,9.9491538],[53.5583282,9.9482596],[53.558017,9.9475837],[53.5576952,9.9467361],[53.5575557,9.946425],[53.5554756,9.9424184]],"layer":"LINK_ATTRIBUTE_FCN","data":{"VEHICLE_TYPES":"0","TRAVEL_DIRECTION":"BOTH"}}');

				// add Diesel Umleitung for Max Brauer Allee
				ops.push('{"op":"override","shape":[[53.555078,9.9416404],[53.5545516,9.9406636],[53.5536397,9.9388933],[53.5531461,9.9380028],[53.5530281,9.9378419],[53.5529101,9.9377882],[53.5526848,9.9374771],[53.5526311,9.9373269],[53.5523093,9.9369299],[53.5521591,9.9368012],[53.5516977,9.9364793],[53.5514402,9.9363291],[53.5510433,9.9361575],[53.5508072,9.9361145],[53.5502386,9.9361038],[53.5498416,9.9361253],[53.5490263,9.9361145],[53.5482323,9.9361253],[53.5477924,9.9360824],[53.5477388,9.9360824],[53.547771,9.9366832],[53.547771,9.937917],[53.5478032,9.9393439],[53.5478675,9.9404812],[53.5479856,9.9417901],[53.548243,9.9432707],[53.5484898,9.9450195],[53.5485649,9.9457061],[53.5489404,9.9484849],[53.5490048,9.949075],[53.5493032,9.9508291],[53.549552,9.9522829],[53.5495842,9.9525619],[53.5496485,9.9536133],[53.54967,9.9544287],[53.5496914,9.9547076],[53.5496593,9.9553835],[53.5496593,9.9555337],[53.5498631,9.9556303],[53.5500777,9.9556947],[53.5508716,9.9558342],[53.5510755,9.9558556],[53.5514402,9.9558878],[53.5516763,9.9558771],[53.551966,9.9558127],[53.5523093,9.955641],[53.5524058,9.9555552],[53.5524917,9.9553835],[53.5527599,9.9550939],[53.5531032,9.9546432],[53.5535753,9.9538279],[53.5540795,9.9530017],[53.5542619,9.9527335],[53.5551846,9.9512208],[53.5552168,9.9511456],[53.5553885,9.9509096],[53.5556352,9.9506414],[53.5558498,9.950459],[53.5574806,9.9498045],[53.5580492,9.9496007],[53.5585964,9.9493647]],"layer":"LINK_ATTRIBUTE_FCn","data":{"FUNCTIONAL_CLASS":"1","SPEED_CATEGORY":"1","TRAVEL_DIRECTION":"BOTH"}}');

				// Block A1 West to use U26
				ops.push('{"op":"override","shape":[[53.50928,10.06345],[53.5093,10.06233],[53.50933,10.06122],[53.50937,10.05949]],"layer":"LINK_ATTRIBUTE_FCN","data":{"VEHICLE_TYPES":"0","TRAVEL_DIRECTION":"BOTH"}}');

				// Block A1 EAST to use U26
				ops.push('{"op":"override","shape":[[53.50929,10.05765],[53.50924,10.05946]],"layer":"LINK_ATTRIBUTE_FCN","data":{"VEHICLE_TYPES":"0","TRAVEL_DIRECTION":"BOTH"}}');

				var overlay_spec = "[" + ops.join(",") + "]";
				submit("OVERLAYHAMBURG", overlay_spec);
			}

			function submit(layername, overlay_spec) {
				var url = 'https://fleet.api.here.com/2/overlays/upload.json?app_id=' + app_id + '&app_code=' + app_code + '\n&storage=readonly&map_name=' + layername;
				$.ajax({
					url: url,
					dataType: "json",
					async: true,
					type: 'post',
					data: {
						overlay_spec: overlay_spec
					},
					success: function(data) {
						$('.loading').hide();
					},
					error: function(xhr, status, e) {
						$('.loading').hide();
						var errorResp = (xhr.responseJSON.issues[0] || {
							"message": "unknown error occured"
						});
						alert(errorResp.message);
					}
				});
			}

			function routeElbtunnel() {
				var start = new H.geo.Point(54.779, 9.41464),
					dest = new H.geo.Point(52.367393, 9.709597);

				routingGroup.removeAll();
				waypoint_start = start;
				markerStart = addMarker(start);
				waypoint_destination = dest;
				markerDestination = addMarker(dest);

				var strip1 = new H.geo.Strip();
				strip1.pushPoint(new H.geo.Point(53.54198, 9.918284));
				strip1.pushPoint(new H.geo.Point(53.54257, 9.916881));
				strip1.pushPoint(new H.geo.Point(53.542704, 9.916584));
				var polyline1 = new H.map.Polyline(strip1, {
					style: {
						lineWidth: 8,
						strokeColor: "red",
						lineCap: 'butt'
					}
				});

				routingGroup.addObject(polyline1);

				var strip2 = new H.geo.Strip();
				strip2.pushPoint(new H.geo.Point(53.541905, 9.918134));
				strip2.pushPoint(new H.geo.Point(53.542668, 9.916326));
				var polyline2 = new H.map.Polyline(strip2, {
					style: {
						lineWidth: 8,
						strokeColor: "red",
						lineCap: 'butt'
					}
				});
				routingGroup.addObject(polyline2);

				var strip3 = new H.geo.Strip();
				strip3.pushPoint(new H.geo.Point(53.542661, 9.915975));
				strip3.pushPoint(new H.geo.Point(53.54182, 9.917989));
				var polyline3 = new H.map.Polyline(strip3, {
					style: {
						lineWidth: 8,
						strokeColor: "red",
						lineCap: 'butt'
					}
				});
				routingGroup.addObject(polyline3);

				var strip4 = new H.geo.Strip();
				strip4.pushPoint(new H.geo.Point(53.542543, 9.914235));
				strip4.pushPoint(new H.geo.Point(53.541504, 9.916934));
				var polyline4 = new H.map.Polyline(strip4, {
					style: {
						lineWidth: 8,
						strokeColor: "red",
						lineCap: 'butt'
					}
				});
				routingGroup.addObject(polyline4);

				if (blocked)
					calculateRoute(new H.geo.Point(53.96865, 10.24574));
				else
					calculateRoute();
			}

			function routeDieselFahrverbotB431() {
				var start = new H.geo.Point(53.566372, 9.909157),
					dest = new H.geo.Point(53.553295, 9.965505);

				routingGroup.removeAll();
				waypoint_start = start;
				markerStart = addMarker(start);
				waypoint_destination = dest;
				markerDestination = addMarker(dest);

				var strip = new H.geo.Strip();
				strip.pushPoint(new H.geo.Point(53.565319, 9.9126828));
				strip.pushPoint(new H.geo.Point(53.5649586, 9.9140775));
				strip.pushPoint(new H.geo.Point(53.5645938, 9.9158156));
				strip.pushPoint(new H.geo.Point(53.564465, 9.916352));
				strip.pushPoint(new H.geo.Point(53.5643041, 9.917264));
				strip.pushPoint(new H.geo.Point(53.5641861, 9.9177039));
				strip.pushPoint(new H.geo.Point(53.564111, 9.9181223));
				strip.pushPoint(new H.geo.Point(53.5640466, 9.9185514));
				strip.pushPoint(new H.geo.Point(53.5639393, 9.9203324));
				strip.pushPoint(new H.geo.Point(53.563875, 9.922092));
				strip.pushPoint(new H.geo.Point(53.5636604, 9.9262011));
				strip.pushPoint(new H.geo.Point(53.5634995, 9.9287546));
				strip.pushPoint(new H.geo.Point(53.5634351, 9.9301064));
				strip.pushPoint(new H.geo.Point(53.5634136, 9.9311256));
				strip.pushPoint(new H.geo.Point(53.5634351, 9.931705));
				strip.pushPoint(new H.geo.Point(53.5634995, 9.9323165));
				strip.pushPoint(new H.geo.Point(53.563553, 9.9326599));
				strip.pushPoint(new H.geo.Point(53.5636604, 9.9331748));
				strip.pushPoint(new H.geo.Point(53.5637033, 9.9335182));
				strip.pushPoint(new H.geo.Point(53.5637569, 9.9346018));
				strip.pushPoint(new H.geo.Point(53.5637462, 9.9358034));
				strip.pushPoint(new H.geo.Point(53.5636497, 9.9384749));
				strip.pushPoint(new H.geo.Point(53.5635746, 9.941536));
				strip.pushPoint(new H.geo.Point(53.5633278, 9.9428415));
				strip.pushPoint(new H.geo.Point(53.5629952, 9.945328));
				strip.pushPoint(new H.geo.Point(53.5629201, 9.9458027));
				strip.pushPoint(new H.geo.Point(53.5628557, 9.9460924));
				strip.pushPoint(new H.geo.Point(53.5626948, 9.947015));
				strip.pushPoint(new H.geo.Point(53.56233, 9.9486029));
				strip.pushPoint(new H.geo.Point(53.562158, 9.9497831));
				strip.pushPoint(new H.geo.Point(53.5617721, 9.9528086));
				strip.pushPoint(new H.geo.Point(53.5613859, 9.9546862));
				strip.pushPoint(new H.geo.Point(53.561353, 9.9549115));
				strip.pushPoint(new H.geo.Point(53.5610211, 9.9563277));
				strip.pushPoint(new H.geo.Point(53.560533, 9.9585164));
				strip.pushPoint(new H.geo.Point(53.5603774, 9.9590957));
				strip.pushPoint(new H.geo.Point(53.5601628, 9.959718));
				strip.pushPoint(new H.geo.Point(53.559798, 9.9606407));
				strip.pushPoint(new H.geo.Point(53.5595298, 9.9611986));
				strip.pushPoint(new H.geo.Point(53.5592616, 9.961617));
				strip.pushPoint(new H.geo.Point(53.5586715, 9.9627221));

				var polyline = new H.map.Polyline(strip, {
					style: {
						lineWidth: 8,
						strokeColor: "red",
						lineCap: 'butt'
					}
				});

				routingGroup.addObject(polyline);

				calculateRoute();
			}

			function routeDieselFahrverbotMaxBrauerAllee() {
				var start = new H.geo.Point(53.555477, 9.939185),
					dest = new H.geo.Point(53.559683, 9.951845);

				routingGroup.removeAll();
				waypoint_start = start;
				markerStart = addMarker(start);
				waypoint_destination = dest;
				markerDestination = addMarker(dest);

				var strip = new H.geo.Strip();
				strip.pushPoint(new H.geo.Point(53.555454, 9.942505));
				strip.pushPoint(new H.geo.Point(53.557021, 9.94552));
				strip.pushPoint(new H.geo.Point(53.558213, 9.948095));
				strip.pushPoint(new H.geo.Point(53.558621, 9.949232));
				strip.pushPoint(new H.geo.Point(53.558621, 9.949232));

				var polyline = new H.map.Polyline(strip, {
					style: {
						lineWidth: 8,
						strokeColor: "red",
						lineCap: 'butt'
					}
				});

				routingGroup.addObject(polyline);
				var wp = {
					lat: 53.54781,
					lng: 9.93955
				};
				if (blocked)
					calculateRoute(wp);
				else
					calculateRoute();
			}

			function routeU26() {
				var start = new H.geo.Point(53.5316, 10.11872),
					dest = new H.geo.Point(53.45951, 10.01067);

				routingGroup.removeAll();
				waypoint_start = start;
				markerStart = addMarker(start);
				waypoint_destination = dest;
				markerDestination = addMarker(dest);

				var strip1 = new H.geo.Strip();
				strip1.pushPoint(new H.geo.Point(53.50928, 10.06345));
				strip1.pushPoint(new H.geo.Point(53.5093, 10.06233));
				strip1.pushPoint(new H.geo.Point(53.50933, 10.06122));
				strip1.pushPoint(new H.geo.Point(53.50937, 10.05949));
				var polyline1 = new H.map.Polyline(strip1, {
					style: {
						lineWidth: 8,
						strokeColor: "red",
						lineCap: 'butt'
					}
				});

				routingGroup.addObject(polyline1);

				var strip2 = new H.geo.Strip();
				strip2.pushPoint(new H.geo.Point(53.50929, 10.05765));
				strip2.pushPoint(new H.geo.Point(53.50924, 10.05946));
				var polyline2 = new H.map.Polyline(strip2, {
					style: {
						lineWidth: 8,
						strokeColor: "red",
						lineCap: 'butt'
					}
				});
				routingGroup.addObject(polyline2);

				calculateRoute();
			}

			function calculateRoute(wp) {
				var routerResource = '/2/calculateroute.json?' + 'app_id=' + app_id + '&app_code=' + app_code;
				var waypoints = "";
				if (wp != undefined)
					waypoints = "&waypoint0=" + waypoint_start.lat + "," + waypoint_start.lng + "&waypoint1=" + wp.lat + "," + wp.lng + "&waypoint2=" + waypoint_destination.lat + "," + waypoint_destination.lng
				else
					waypoints = "&waypoint0=" + waypoint_start.lat + "," + waypoint_start.lng + "&waypoint1=" + waypoint_destination.lat + "," + waypoint_destination.lng
				var url = routerResource + '&mode=fastest;car;traffic:enabled' + waypoints;

				$('.loading').show();
				$.ajax({
					url: 'https://fleet.api.here.com' + url + '&algopts=nohlprouter' + (blocked ? '&overlays=OVERLAYHAMBURG' : ''),
					dataType: "json",
					async: true,
					type: 'get',
					success: function(data) {
						$('.loading').hide();
						parseRoutingResponse(data);
					},
					error: function(xhr, status, e) {
						$('.loading').hide();
						var errorResp = (xhr.responseJSON.issues[0] || {
							"message": "unknown error occured"
						});
						alert(errorResp.message);
					}
				});
			}

			function parseRoutingResponse(resp) {
				routeLinkHashMap = new Object();

				// create link objects
				for (var r = 0; r < resp.response.route.length; r++) {
					for (var k = 0; k < resp.response.route[r].leg.length; k++) {
						for (var m = 0; m < resp.response.route[r].leg[k].link.length; m++) {
							// only add new link if it does not exist so far - so alternatives are not drawn multiple times
							var linkId = (resp.response.route[r].leg[k].link[m].linkId.lastIndexOf("+", 0) === 0 ? resp.response.route[r].leg[k].link[m].linkId.substring(1) : resp.response.route[r].leg[k].link[m].linkId);
							if (routeLinkHashMap[linkId] == null) {
								var strip = new H.geo.Strip(),
									shape = resp.response.route[r].leg[k].link[m].shape,
									i,
									l = shape.length;

								for (i = 0; i < l; i += 2) {
									strip.pushLatLngAlt(shape[i], shape[i + 1], 0);
								}

								var link = new H.map.Polyline(strip, {
									style: {
										lineWidth: (routeStroke - (r + 1)), // alternatives get smaller line with
										strokeColor: routeColor[r],
										lineCap: 'butt'
									}
								});
								link.setArrows({
									color: "#F00F",
									width: 2,
									length: 3,
									frequency: 8
								});
								link.$linkId = resp.response.route[r].leg[k].link[m].linkId;

								//The router can send back links ids with "-" or "+" prefix: only "-" prefix is kept and stored in this HashMap, the "+" is removed
								routeLinkHashMap[linkId] = link;
								legLinkHashMap[linkId] = resp.response.route[r].leg[k].link[m];
								// add event listener to link
								link.addEventListener("mouseover", function(e) {
									if (currentOpenBubble)
										ui.removeBubble(currentOpenBubble);
									var html = '<div>' +
										'<p style="font-family:Arial,sans-serif; font-size:12px;">LinkId: ' + e.target.$linkId + '</p>'
									'</div>';

									var pos = map.screenToGeo(e.currentPointer.viewportX, e.currentPointer.viewportY);

									currentOpenBubble = new H.ui.InfoBubble(pos, {
										content: html
									});
									ui.addBubble(currentOpenBubble);
								});
							}
						}
					}
				}

				for (var r = 0; r < resp.response.route.length; r++) {
					for (var k = 0; k < resp.response.route[r].leg.length; k++) {
						for (var linkIdx in resp.response.route[0].leg[k].link) {
							var strip = new H.geo.Strip();
							var shape = resp.response.route[0].leg[k].link[linkIdx].shape;
							var l = shape.length;

							for (var i = 0; i < l; i = i + 2) {
								strip.pushLatLngAlt.apply(strip, [shape[i], shape[i + 1]].map(function(item) {
									return parseFloat(item);
								}));
							}
							var polyline = createPolylineForIndex(strip, linkIdx);
							polyline.setArrows(true);
							routingGroup.addObject(polyline);
						}
						var maneuvers = resp.response.route[0].leg[k].maneuver
						for (var i in maneuvers) {
							var lat = maneuvers[i].position.latitude;
							var lon = maneuvers[i].position.longitude;
							var point = new H.geo.Point(parseFloat(lat), parseFloat(lon));
							var instr = maneuvers[i].instruction.replace(new RegExp("</span>", 'g'), "").replace(new RegExp('<span class="[a-z\-]+">', 'g'), "");
							var marker = new H.map.Marker(point, {
								icon: createIconMarker(maneuvers[i].travelTime + " seconds", instr)
							});
							routingGroup.addObject(marker);
						}
					}
				}
				map.addObject(routingGroup);
				map.setViewBounds(routingGroup.getBounds());
			}

			function createIconMarker(line1, line2) {
				var svgMarker = svgMarkerImage_Line;
				svgMarker = svgMarker.replace(/__line1__/g, line1);
				svgMarker = svgMarker.replace(/__line2__/g, line2);
				svgMarker = svgMarker.replace(/__width__/g, line2.length * 4 + 20);
				svgMarker = svgMarker.replace(/__widthAll__/g, line2.length * 4 + 200);
				return new H.map.Icon(svgMarker, {
					anchor: new H.math.Point(24, 57)
				});
			};

			function getIcon(no) {
				if (icons[no] == undefined) {
					icons[no] = new H.map.Icon(iconSVG.replace(/__NO__/g, no));
				}
				return icons[no];
			}

			function requestTraffic(bbox) {
				if (map.getZoom() < 10) {
					group.removeAll();
					return;
				}

				if (map.getViewBounds().getWidth() > 10 || map.getViewBounds().getHeight() > 10) {
					var center = map.getCenter(),
						top = center.lat + 5,
						left = center.lng - 5,
						bottom = center.lat - 5,
						right = center.lng + 5;

					bbox = new H.geo.Rect(top, left, bottom, right);
				}

				if (trafficInit == true)
					$('.loading').show();

				group.removeAll();
				var url = 'http' + (secure ? 's' : '') + '://traffic.api.here.com/traffic/6.2/flow.json?app_id=' + app_id + '&app_code=' + app_code +
					'&bbox=' + bbox.getTop() + ',' + bbox.getLeft() + ';' +
					bbox.getBottom() + ',' + bbox.getRight() +
					'&i18n=true&responseattributes=sh,fc&locationreferences=tmc,shp&units=metric&jsoncallback=updateTraffic';


				script = document.createElement("script");
				script.src = url;
				document.body.appendChild(script);
			}

			function updateTraffic(response) {
				var i = 0,
					j = 0,
					k = 0,
					l = 0,
					m = 0,
					n = 0,
					z = 0;

				if (response.RWS && response.RWS.length > 0) {
					var ebuCountryCode = response.RWS[0].EBU_COUNTRY_CODE,
						extendedCountryCode = response.RWS[0].EXTENDED_COUNTRY_CODE,
						tableId = response.RWS[0].TABLE_ID,
						rigtSideCountry = getRightSideCountry(ebuCountryCode, extendedCountryCode, tableId);

					for (i = 0; i < response.RWS.length; i++) {
						if (response.RWS[i].RW) {
							for (j = 0; j < response.RWS[i].RW.length; j++) {
								if (response.RWS[i].RW[j].FIS) {
									for (k = 0; k < response.RWS[i].RW[j].FIS.length; k++) {
										if (response.RWS[i].RW[j].FIS[k]) {
											for (l = 0; l < response.RWS[i].RW[j].FIS[k].FI.length; l++) {
												var FI = response.RWS[i].RW[j].FIS[k].FI[l],
													shp,
													JF,
													CN,
													point;

												if (FI.SHP && FI.CF) {
													JF = FI.CF[0].JF;
													CN = FI.CF[0].CN;

													for (m = 0; m < FI.SHP.length; m++) {
														var debugpoints = new Array();

														var strip = new H.geo.Strip(),
															centerGridSizeXReduction = Math.abs(Math.cos(parseFloat(FI.SHP[m].value[0].trim().split(" ")[0].split(",")[0]) * Math.PI / 180.0));

														for (n = 0; n < FI.SHP[m].value.length; n++) {
															var cpoints = FI.SHP[m].value[n].trim().split(" ");

															for (z = 0; z < cpoints.length; z++) {
																strip.pushLatLngAlt.apply(strip, cpoints[z].split(',').map(function(item) {
																	return parseFloat(item);
																}));
															}
														}


														var fc = parseInt(FI.SHP[m].FC);
														var shiftedStrip = shiftPolyline(strip, rigtSideCountry ? SHIFTRIGHT[fc] : SHIFTLEFT[fc], centerGridSizeXReduction);

														var polyline = new H.map.Polyline(shiftedStrip, {
															style: {
																lineWidth: 1,
																strokeColor: getColorForJF(JF),
																fillColor: "rgb(0,0,0)"
															}
														});

														polyline.$JF = JF;
														polyline.$CN = CN;

														polyline.addEventListener("pointerdown", function(e) {
															if (currentBubble)
																ui.removeBubble(currentBubble);
															e.target.setStyle({
																lineWidth: 1,
																strokeColor: getColorForJF(e.target.$JF),
																lineJoin: "round"
															});
															var html = '<div>' +
																'<p style="font-family:Arial,sans-serif; font-size:12px;">JamFactor: ' + e.target.$JF + '</p>' +
																'<p style="font-family:Arial,sans-serif; font-size:12px;">Confidence: ' + e.target.$CN + '</p>' +
																'</div>';

															var pos = map.screenToGeo(e.currentPointer.viewportX, e.currentPointer.viewportY);

															currentBubble = new H.ui.InfoBubble(pos, {
																content: html
															});
															ui.addBubble(currentBubble);
														});
														polyline.addEventListener('pointerenter', createPointerEnterLinkHandler(polyline));
														polyline.addEventListener('pointerleave', createPointerLeaveLinkHandler(polyline));
														group.addObject(polyline);
													}
												}
											}
										}
									}
								}
							}
						}
					}
					map.addObject(group);
					trafficInit = true;
					if (trafficInit == true && layerInit == true)
						$('.loading').hide();
				} else if (response.type && response.Details) {
					var d = document.getElementById("error");
					d.innerHTML = response.Details;
					if (trafficInit == true && layerInit == true)
						$('.loading').hide();
				}
			}

			function createPointerEnterLinkHandler(polyline) {
				return function(e) {
					polyline.setStyle({
						lineWidth: 8,
						strokeColor: getColorForJF(polyline.$JF),
						lineJoin: "round"
					});
				};
			}

			function createPointerLeaveLinkHandler(polyline) {
				return function(e) {
					polyline.setStyle({
						lineWidth: 1,
						strokeColor: getColorForJF(polyline.$JF),
						lineJoin: "round"
					});
				};
			}

			function getRightSideCountry(ebuCountryCode, extendedCountryCode, tableId) {
				if (tableId.length == 1)
					tableId = "0" + tableId;

				var tmctable = extendedCountryCode + " " + ebuCountryCode + tableId,
					ret = true;

				if (
					tmctable == "F1 D10" || // Taiwan
					tmctable == "D0 A17" || // South Africa
					tmctable == "E1 C07" || // Great Britain
					tmctable == "E3 242" || // Ireland
					tmctable == "F0 153" || // Australia New South Wales, Australian Capital Territory
					tmctable == "F0 254" || // Australia New South Wales, Australian Capital Territory
					tmctable == "F0 301" || // Australia Victoria
					tmctable == "F0 456" || // Australia Queensland
					tmctable == "F0 557" || // Australia South Australia
					tmctable == "F0 658" || // Australia Western Australia
					tmctable == "F0 759" || // Australia Tasmania
					tmctable == "F0 860" || // Australia Northern Territory
					tmctable == "F0 F05" || // Malaysia
					tmctable == "F1 941" || // New Zealand
					tmctable == "F2 502" || // India - Maharashtra, Madhya Pradesh, Jharkhand, Assam, Odisha, Bihar, Gujarat, West Bengal
					tmctable == "F2 503" || // India - Tamil Nadu, Kerala, Andhra Pradesh, Goa, Karnataka
					tmctable == "F2 504" || // India - Rajasthan, Uttar Pradesh, Delhi, Haryana, Chandigarh, Punjab
					tmctable == "F2 A01" || // Singapore
					tmctable == "F2 C21" || // Indonesia
					tmctable == "F3 219" // Thailand
				) {
					ret = false;
				}
				return ret;
			}

			function shiftPolyline(strip, offsetToRightMeter, centerGridSizeXReduction) {
				var latLonZ = strip.getLatLngAltArray(),
					shiftedLatLonZ = new Array(),
					i = 0,
					shiftedStrip = new H.geo.Strip();

				for (; i < latLonZ.length / 3; i++) {
					var i1 = i < latLonZ.length / 3 - 1 ? i : i - 1,
						y1 = latLonZ[3 * i1],
						x1 = latLonZ[3 * i1 + 1],
						y2 = latLonZ[3 * i1 + 3],
						x2 = latLonZ[3 * i1 + 4],
						dx = (x2 - x1) * centerGridSizeXReduction,
						dy = y2 - y1,
						length = Math.sqrt(dx * dx + dy * dy);

					if (length == 0) {
						length = 0.00001;
					}
					shiftedLatLonZ[3 * i] = latLonZ[3 * i] + ((dx * offsetToRightMeter) * -1) / (1.113238715696961 * 100000.0 * length);
					shiftedLatLonZ[3 * i + 1] = latLonZ[3 * i + 1] + (dy * offsetToRightMeter) / (1.113238715696961 * 100000.0 * length * centerGridSizeXReduction);
					shiftedLatLonZ[3 * i + 2] = latLonZ[3 * i + 2];
				}

				//! TODO why the hell there is no fromLatLngAlt Array()?????? 
				for (i = 0; i < shiftedLatLonZ.length; i += 3) {
					shiftedStrip.pushPoint(new H.geo.Point(shiftedLatLonZ[i], shiftedLatLonZ[i + 1]));
				}
				return shiftedStrip;
			}

			function getColorForJF(jamFactor) {
				if (jamFactor == -1)
					return 'rgb(0, 77, 168)';
				else if (jamFactor < 4.0)
					return 'rgb(138,198,144)';
				else if (jamFactor < 6.5)
					return 'rgb(254,212,3)';
				else if (jamFactor < 8.0)
					return 'rgb(254,153,37)';
				else if (jamFactor < 10.0)
					return 'rgb(227,15,56)';
				else if (jamFactor == 10.0 || jamFactor > 10.0)
					return 'rgba(0,0,0)';
			}

			$(document).ready(function() {
				init();
			});

			var x, i, j, selElmnt, a, b, c;
			x = document.getElementsByClassName("custom-select");
			for (i = 0; i < x.length; i++) {
				selElmnt = x[i].getElementsByTagName("select")[0];
				a = document.createElement("DIV");
				a.setAttribute("class", "select-selected");
				a.innerHTML = selElmnt.options[selElmnt.selectedIndex].innerHTML;
				x[i].appendChild(a);

				b = document.createElement("DIV");
				b.setAttribute("class", "select-items select-hide");

				for (j = 1; j < selElmnt.length; j++) {
					c = document.createElement("DIV");
					c.innerHTML = selElmnt.options[j].innerHTML;
					c.addEventListener("click", function(e) {
						var y, i, k, s, h;
						s = this.parentNode.parentNode.getElementsByTagName("select")[0];
						h = this.parentNode.previousSibling;
						for (i = 0; i < s.length; i++) {
							if (s.options[i].innerHTML == this.innerHTML) {
								s.selectedIndex = i;
								h.innerHTML = this.innerHTML;
								y = this.parentNode.getElementsByClassName("same-as-selected");
								for (k = 0; k < y.length; k++) {
									y[k].removeAttribute("class");
								}
								this.setAttribute("class", "same-as-selected");
								break;
							}
						}
						h.click();
					});
					b.appendChild(c);
				}

				x[i].appendChild(b);
				a.addEventListener("click", function(e) {
					e.stopPropagation();
					closeAllSelect(this);
					this.nextSibling.classList.toggle("select-hide");
					this.classList.toggle("select-arrow-active");
				});
			}

			function closeAllSelect(elmnt) {
				var x, y, i, arrNo = [];
				x = document.getElementsByClassName("select-items");
				y = document.getElementsByClassName("select-selected");
				for (i = 0; i < y.length; i++) {
					if (elmnt == y[i]) {
						arrNo.push(i)
					} else {
						y[i].classList.remove("select-arrow-active");
					}
				}
				for (i = 0; i < x.length; i++) {
					if (arrNo.indexOf(i)) {
						x[i].classList.add("select-hide");
					}
				}
			}
			document.addEventListener("click", closeAllSelect);

			var submitTrace = function(trace, direction) {
				var url = 'https://fleet.api.here.com/2/calculateroute.json?routeMatch=1&mode=fastest;car;traffic:disabled'
				url += "&app_id=" + app_id;
				url += "&app_code=" + app_code;

				$.ajax({
					url: url,
					dataType: "json",
					async: true,
					type: 'post',
					data: trace,
					contentType: 'application/octet-stream',
					success: direction == "FORWARD" ? gotRouteMatchResponseForward : gotRouteMatchResponseBackward,
					error: function(xhr, status, e) {
						alert((xhr.responseJSON.issues[0].message ? xhr.responseJSON.issues[0].message : xhr.responseJSON.issues[0]) || xhr.responseJSON);
					}
				});
			}

			function gotRouteMatchResponseForward(resp) {
				gotRouteMatchResponse(resp, "FORWARD");
			}

			function gotRouteMatchResponseBackward(resp) {
				gotRouteMatchResponse(resp, "BACKWARD");
			}

			function gotRouteMatchResponse(resp, direction) {
				var routeLinks = resp.response.route[0].leg[0].link,
					crecoordinates = [];

				for (var i = 0; i < routeLinks.length; i++) {
					var coords = routeLinks[i].shape;
					for (var c = 0; c < coords.length; c += 2) {
						crecoordinates.push("[" + coords[0] + "," + coords[1] + "]");
					}
				}
				crerequests.push({
					coordinates: crecoordinates,
					direction: direction
				});
				if (crerequests.length == Object.keys(rmerequests).length) {
					submitBypassNetwork();
				}
			}
		</script>

</body>

</html>